<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Pixel Place Realtime</title>
  <style>
    body {
      margin: 0;
      background: #1e1e1e;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    canvas {
      border: 1px solid #555;
      background: white;
      image-rendering: pixelated;
      cursor: crosshair;
    }
    .controls {
      margin: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .color-picker {
      width: 40px;
      height: 40px;
      border: none;
      cursor: pointer;
    }
    #pixel-count {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ðŸŽ¨ Pixel Place Realtime</h1>
  <div class="controls">
    <input type="color" id="color-picker" class="color-picker" value="#ff0000">
    <span id="pixel-count">6 pixels restants</span>
  </div>
  <canvas id="canvas" width="800" height="800"></canvas>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const PIXEL_SIZE = 10;
    const MAX_PIXELS_PER_MIN = 6;

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const colorPicker = document.getElementById("color-picker");
    const pixelCountDisplay = document.getElementById("pixel-count");

    let scale = 1;
    let pixelCount = 0;
    let cooldown = false;
    let user = { id: "anonymous" }; // simplifiÃ© pour usage sans auth

    const supabase = window.supabase.createClient(
      "https://wuagahavmbugmnuzsouf.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1YWdhaGF2bWJ1Z21udXpzb3VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MDM2NTksImV4cCI6MjA2ODE3OTY1OX0.mjf9cUleV_oq8TsWeKvPVOJSGPc98AyGyfJeA-Tpvho"
    );

    async function loadPixels() {
      const { data, error } = await supabase.from("pixels").select("x, y, color");
      if (error) {
        console.error("Erreur chargement pixels:", error);
        return;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      data.forEach(({ x, y, color }) => {
        ctx.fillStyle = color;
        ctx.fillRect(x, y, PIXEL_SIZE, PIXEL_SIZE);
      });
    }

    function updateUI() {
      pixelCountDisplay.textContent = `${MAX_PIXELS_PER_MIN - pixelCount} pixels restants`;
    }

    function startCooldown() {
      if (pixelCount >= MAX_PIXELS_PER_MIN) {
        cooldown = true;
        setTimeout(() => {
          pixelCount = 0;
          cooldown = false;
          updateUI();
        }, 60 * 1000);
      }
    }

    async function placePixel(e) {
      if (cooldown || pixelCount >= MAX_PIXELS_PER_MIN) return;

      const rect = canvas.getBoundingClientRect();
      const canvasX = (e.clientX - rect.left) / scale;
      const canvasY = (e.clientY - rect.top) / scale;

      const x = Math.floor(canvasX / PIXEL_SIZE) * PIXEL_SIZE;
      const y = Math.floor(canvasY / PIXEL_SIZE) * PIXEL_SIZE;

      const color = colorPicker.value;

      const { error } = await supabase
        .from("pixels")
        .insert({ x, y, color, user_id: user.id });

      if (error) {
        console.error("Erreur insertion pixel:", error);
        return;
      }

      pixelCount++;
      updateUI();
      startCooldown();
    }

    function updateCanvas() {
      ctx.setTransform(scale, 0, 0, scale, 0, 0);
      loadPixels();
    }

    canvas.addEventListener("click", placePixel);

    // Zoom Ã  la molette
    canvas.addEventListener("wheel", (e) => {
      e.preventDefault();
      const delta = e.deltaY > 0 ? -0.1 : 0.1;
      scale += delta;
      scale = Math.max(0.5, Math.min(5, scale));
      updateCanvas();
    });

    // Ã‰coute temps rÃ©el Supabase
    supabase
      .channel("realtime:pixels")
      .on("postgres_changes", { event: "INSERT", schema: "public", table: "pixels" }, (payload) => {
        const { x, y, color } = payload.new;
        ctx.fillStyle = color;
        ctx.fillRect(x, y, PIXEL_SIZE, PIXEL_SIZE);
      })
      .subscribe();

    // Initialisation
    updateCanvas();
    updateUI();
  </script>
</body>
</html>
