<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mes amis</title>
  <style>
    :root {
      --accent: #e50914;
      --bg-1: #121212;
      --bg-2: #1e1e1e;
      --bg-header: #141414;
      --online: #00ff88;
      --offline: #888;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg-1);
      color: #ffffff;
      padding: 20px;
      margin: 0;
    }

    header {
      background-color: var(--bg-header);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-weight: bold;
      font-size: 20px;
      color: var(--accent);
    }

    .nav-links {
      list-style: none;
      padding: 0;
      display: flex;
      gap: 20px;
      margin: 0;
    }

    .nav-links a {
      color: #ffffff;
      text-decoration: none;
      font-weight: bold;
      font-size: 16px;
    }

    h1 {
      margin-top: 30px;
    }

    h2 {
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
      margin-top: 40px;
      margin-bottom: 10px;
      font-size: 20px;
    }

    .friend-card {
      background: var(--bg-2);
      padding: 16px 20px;
      margin: 12px 0;
      border-radius: 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      align-items: center;
    }

    .friend-card-content {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .friend-name-line {
      font-size: 18px;
    }

    .online {
      color: var(--online);
      font-size: 14px;
      margin-left: 4px;
    }

    .offline {
      color: var(--offline);
      font-size: 14px;
      margin-left: 4px;
    }

    .watching-activity {
      font-size: 15px;
      line-height: 1.3;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .watching-activity strong {
      font-weight: bold;
    }

    .watching-thumb {
      width: 100px;
      aspect-ratio: 16 / 9;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #333;
    }

    .friend-card-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: stretch;
    }

    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1.2;
    }

    button.chat-btn {
      background: #0066ff;
    }

    a.back-link {
      color: var(--accent);
      text-decoration: none;
      font-weight: bold;
      display: inline-block;
      margin-top: 10px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .nav-links {
        flex-direction: column;
        gap: 10px;
        width: 100%;
      }

      .friend-card {
        grid-template-columns: 1fr;
      }

      .friend-card-actions {
        flex-direction: row;
        justify-content: flex-start;
      }

      .watching-thumb {
        width: 100%;
        max-width: 300px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">BNZ</div>
    <nav>
      <ul class="nav-links">
        <li><a href="accueil.html">Accueil</a></li>
        <li><a href="journal.html">Journal</a></li>
        <li><a href="lecteurtest.html">Profil</a></li>
        <li><a href="profil.html">D√©couvrir</a></li>
        <li><a href="index.html">Home</a></li>
        <li><a href="amis.html">Amis</a></li>
        <li><a href="mes-amis.html">Mes amis</a></li>
        <li><a href="compte.html">Votre Compte</a></li>
      </ul>
    </nav>
  </header>
  
  <div style="margin-top: 10px;">
    <a class="back-link" href="index.html">‚Üê Retour</a>
  </div>

  <h1>üë• Mes amis</h1>

  <div class="section">
    <h2>Demandes re√ßues</h2>
    <div id="received-requests">Chargement...</div>
  </div>

  <div class="section">
    <h2>Amis accept√©s</h2>
    <div id="accepted-friends">Chargement...</div>
  </div>

<script type="module">
  /*************************************************
   * Initialisation Supabase
   *************************************************/
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabaseUrl = 'https://wuagahavmbugmnuzsouf.supabase.co';
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1YWdhaGF2bWJ1Z21udXpzb3VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MDM2NTksImV4cCI6MjA2ODE3OTY1OX0.mjf9cUleV_oq8TsWeKvPVOJSGPc98AyGyfJeA-Tpvho';
  const supabase = createClient(supabaseUrl, supabaseAnonKey);

  const PLACEHOLDER_IMG = 'img/placeholder-episode.jpg';

  // √âchapper les caract√®res dangereux (s√©curit√© XSS)
  const escapeHTML = (str = '') =>
    str.replace(/[&<>"']/g, ch => ({
      '&':'&amp;',
      '<':'&lt;',
      '>':'&gt;',
      '"':'&quot;',
      "'":'&#39;'
    }[ch]));

  /*************************************************
   * R√©cup√©ration image √©pisode
   *************************************************/
  async function fetchEpisodeImageFromCatalog({ show_id, season, episode }) {
    if (!show_id || season == null || episode == null) return null;
    const { data, error } = await supabase
      .from('episodes')
      .select('image_url')
      .eq('show_id', show_id)
      .eq('season_number', season)
      .eq('episode_number', episode)
      .maybeSingle();
    if (error) {
      console.warn('fetchEpisodeImageFromCatalog error:', error);
      return null;
    }
    return data?.image_url ?? null;
  }

  function normalizeEpisodeImage(url) {
    if (!url) return null;
    const u = String(url).trim();
    if (!u || u.toUpperCase() === 'NULL' || u === '-') return null;
    return u;
  }

  function buildEpisodeImgEl(url, alt='Vignette √©pisode') {
    if (!url) return null;
    const img = document.createElement('img');
    img.className = 'watching-thumb';
    img.src = url;
    img.alt = alt;
    img.loading = 'lazy';
    return img;
  }

  /*************************************************
   * Gestion session utilisateur
   *************************************************/
  async function manageSession() {
    const { data: sessionData, error: sessErr } = await supabase.auth.getSession();
    if (sessErr) console.error('Erreur session:', sessErr);
    const session = sessionData?.session;
    if (!session) {
      document.body.innerHTML = '<h2>üîí Vous devez √™tre connect√©.</h2>';
      return;
    }
    const userId = session.user.id;
    await loadPendingRequests(userId);
    await loadAcceptedFriends(userId);
  }

  /*************************************************
   * Chargement des demandes re√ßues
   *************************************************/
  async function loadPendingRequests(userId) {
    const container = document.getElementById('received-requests');
    container.innerHTML = '';

    const { data: pendingRequests, error } = await supabase
      .from('friends')
      .select('id, requester:requester(id, username)')
      .eq('requested', userId)
      .eq('status', 'pending');

    if (error) {
      console.error('Erreur fetch demandes:', error);
      container.textContent = 'Erreur lors du chargement.';
      return;
    }

    if (!pendingRequests?.length) {
      container.textContent = 'Aucune demande pour le moment.';
      return;
    }

    pendingRequests.forEach(req => {
      const uname = escapeHTML(req.requester?.username ?? 'Utilisateur');

      const card = document.createElement('div');
      card.className = 'friend-card';

      const content = document.createElement('div');
      content.className = 'friend-card-content';
      content.innerHTML = `<div class="friend-name-line"><strong>${uname}</strong> vous a envoy√© une demande.</div>`;

      const actions = document.createElement('div');
      actions.className = 'friend-card-actions';

      const acceptBtn = document.createElement('button');
      acceptBtn.textContent = 'Accepter';
      acceptBtn.onclick = async () => {
        await supabase.from('friends').update({ status: 'accepted' }).eq('id', req.id);
        manageSession();
      };

      const rejectBtn = document.createElement('button');
      rejectBtn.textContent = 'Refuser';
      rejectBtn.onclick = async () => {
        await supabase.from('friends').update({ status: 'rejected' }).eq('id', req.id);
        manageSession();
      };

      actions.append(acceptBtn, rejectBtn);
      card.append(content, actions);
      container.appendChild(card);
    });
  }

  /*************************************************
   * Chargement des amis accept√©s
   *************************************************/
  async function loadAcceptedFriends(userId) {
    const container = document.getElementById('accepted-friends');
    container.innerHTML = '';

const { data: friends, error } = await supabase
  .from('friends')
  .select(`
    id,
    status,
    requester:requester(id, username, is_online, currently_watching, episode_number, episode_image, current_season, show_id),
    requested:requested(id, username, is_online, currently_watching, episode_number, episode_image, current_season, show_id)
  `)
  .or(`requester.eq.${userId},requested.eq.${userId}`)
  .eq('status', 'accepted');



    if (error) {
      console.error('Erreur fetch amis:', error);
      container.textContent = 'Erreur lors du chargement.';
      return;
    }

    if (!friends?.length) {
      container.textContent = "Vous n'avez pas encore d'amis.";
      return;
    }

    for (const rel of friends) {
      const friend = (rel.requester?.id === userId) ? rel.requested : rel.requester;
      if (!friend) continue;

      const rawName = friend.username ?? 'Utilisateur';
      const uname = escapeHTML(rawName);
      const isOnline = !!friend.is_online;

      const statusSpan = document.createElement('span');
      statusSpan.className = isOnline ? 'online' : 'offline';
      statusSpan.textContent = isOnline ? 'üü¢ En ligne' : 'üî¥ Hors ligne';

      const watchingEl = friend.currently_watching ? document.createElement('div') : null;
      if (watchingEl) {
        watchingEl.className = 'watching-activity';
        const safeTitle = escapeHTML(friend.currently_watching);
const caption = [
  friend.current_season ? `S${friend.current_season}` : '',
  friend.episode_number ? `√âpisode ${friend.episode_number}` : ''
].filter(Boolean).join(' ‚Äì ');

// Utilisation de textContent au lieu de innerHTML pour √©viter les probl√®mes de XSS
watchingEl.textContent = `üé¨ Regarde : ${safeTitle}`;
if (caption) {
  const captionEl = document.createElement('span');
  captionEl.textContent = ` ‚Äì ${caption}`;
  watchingEl.appendChild(captionEl);
}

// Construction de l'√©l√©ment image de mani√®re s√©curis√©e
let imgURL = normalizeEpisodeImage(friend.episode_image);
if (!imgURL) {
  imgURL = await fetchEpisodeImageFromCatalog({
    show_id: friend.show_id,
    season: friend.current_season,
    episode: friend.episode_number
  });
}
if (!imgURL) imgURL = PLACEHOLDER_IMG;
const imgEl = buildEpisodeImgEl(imgURL);
if (imgEl) watchingEl.appendChild(imgEl);


      const card = document.createElement('div');
      card.className = 'friend-card';

      const content = document.createElement('div');
      content.className = 'friend-card-content';
      const nameLine = document.createElement('div');
      nameLine.className = 'friend-name-line';
      nameLine.innerHTML = \`<strong>\${uname}</strong> \`;
      nameLine.appendChild(statusSpan);
      content.appendChild(nameLine);
      if (watchingEl) content.appendChild(watchingEl);

      const actions = document.createElement('div');
      actions.className = 'friend-card-actions';

      const chatBtn = document.createElement('button');
      chatBtn.className = 'chat-btn';
      chatBtn.textContent = 'üí¨ Chat';
      chatBtn.onclick = () => {
        window.location.href = \`chat.html?user=\${friend.id}\`;
      };

      const removeBtn = document.createElement('button');
      removeBtn.textContent = '‚ùå Supprimer';
      removeBtn.onclick = async () => {
        await supabase.from('friends').delete().eq('id', rel.id);
        manageSession();
      };

      actions.append(chatBtn, removeBtn);
      card.append(content, actions);
      container.appendChild(card);
    }
  }

  // Chargement initial et refresh toutes les 10s
  await manageSession();
  setInterval(manageSession, 10000);
</script>

</body>
</html>
