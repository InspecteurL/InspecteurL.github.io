<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mes amis</title>
  <style>
    :root {
      --accent: #e50914;
      --bg-1: #121212;
      --bg-2: #1e1e1e;
      --bg-header: #141414;
      --online: #00ff88;
      --offline: #888;
    }
    body { font-family: Arial,sans-serif; background:var(--bg-1); color:#fff; padding:20px; margin:0; }
    header { background:var(--bg-header); padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
    .logo{font-weight:bold;font-size:20px;color:var(--accent);}
    .nav-links{list-style:none;padding:0;display:flex;gap:20px;margin:0;}
    .nav-links a{color:#fff;text-decoration:none;font-weight:bold;font-size:16px;}
    h1{margin-top:30px;}
    h2{border-bottom:1px solid #444;padding-bottom:5px;margin-top:40px;margin-bottom:10px;font-size:20px;}
    .friend-card{background:var(--bg-2);padding:16px 20px;margin:12px 0;border-radius:10px;display:grid;grid-template-columns:auto 100px;gap:16px;align-items:center;}
    .friend-card-content{display:flex;flex-direction:column;gap:6px;}
    .friend-name-line{font-size:18px;}
    .online{color:var(--online);font-size:14px;margin-left:4px;}
    .offline{color:var(--offline);font-size:14px;margin-left:4px;}
    .watching-activity{font-size:15px;line-height:1.3;display:flex;flex-direction:column;gap:6px;}
    .watching-thumb{width:100px;aspect-ratio:16/9;object-fit:cover;border-radius:6px;border:1px solid #333;}
    .friend-card-actions{display:flex;flex-direction:column;gap:8px;align-items:stretch;}
    button{background:var(--accent);color:#fff;border:none;padding:6px 10px;border-radius:5px;cursor:pointer;font-size:14px;line-height:1.2;}
    button.chat-btn{background:#0066ff;}
    button.invite-btn{background:#00b050;}
    a.back-link{color:var(--accent);text-decoration:none;font-weight:bold;display:inline-block;margin-top:10px;}
    @media (max-width:768px){
      header{flex-direction:column;align-items:flex-start;}
      .nav-links{flex-direction:column;gap:10px;width:100%;}
      .friend-card{grid-template-columns:1fr;}
      .friend-card-actions{flex-direction:row;justify-content:flex-start;}
      .watching-thumb{width:100%;max-width:300px;}
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">BNZ</div>
    <nav>
      <ul class="nav-links">
        <li><a href="accueil.html">Accueil</a></li>
        <li><a href="journal.html">Journal</a></li>
        <li><a href="lecteurtest.html">Profil</a></li>
        <li><a href="profil.html">D√©couvrir</a></li>
        <li><a href="index.html">Home</a></li>
        <li><a href="amis.html">Amis</a></li>
        <li><a href="mes-amis.html">Mes amis</a></li>
        <li><a href="compte.html">Votre Compte</a></li>
      </ul>
    </nav>
  </header>
  
  <div style="margin-top: 10px;">
    <a class="back-link" href="index.html">‚Üê Retour</a>
  </div>

  <h1>üë• Mes amis</h1>

  <div class="section">
    <h2>Demandes re√ßues</h2>
    <div id="received-requests">Chargement...</div>
  </div>

  <div class="section">
    <h2>Amis accept√©s</h2>
    <div id="accepted-friends">Chargement...</div>
  </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabaseUrl = 'https://wuagahavmbugmnuzsouf.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1YWdhaGF2bWJ1Z21udXpzb3VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MDM2NTksImV4cCI6MjA2ODE3OTY1OX0.mjf9cUleV_oq8TsWeKvPVOJSGPc98AyGyfJeA-Tpvho';
const supabase = createClient(supabaseUrl, supabaseAnonKey);

const PLACEHOLDER_IMG = 'img/placeholder-episode.jpg';

const escapeHTML = (str = '') =>
  str.replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));

/* ------------------ UUID util ------------------ */
function uuidv4() {
  // crypto.randomUUID si dispo
  if (crypto?.randomUUID) return crypto.randomUUID();
  // fallback
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
    const r=(Math.random()*16)|0;
    const v=c==='x'?r:(r&0x3)|0x8;
    return v.toString(16);
  });
}

/* ------------------ Session + chargement ------------------ */
let currentUser = null; // {id:...}

async function manageSession() {
  const { data: sessionData, error: sessErr } = await supabase.auth.getSession();
  if (sessErr) console.error('Erreur session:', sessErr);

  const session = sessionData?.session;
  if (!session) {
    document.body.innerHTML = 'üîí Vous devez √™tre connect√©.';
    return;
  }
  currentUser = { id: session.user.id };
  await loadPendingRequests(currentUser.id);
  await loadAcceptedFriends(currentUser.id);
}

/* ------------------ Demandes re√ßues ------------------ */
async function loadPendingRequests(userId) {
  const receivedContainer = document.getElementById('received-requests');
  receivedContainer.innerHTML = '';

  const { data: pendingRequests, error } = await supabase
    .from('friends')
    .select(`
      id,
      status,
      requester:requester ( id, username )
    `)
    .eq('requested', userId)
    .eq('status', 'pending');

  if (error) {
    console.error('Erreur fetch demandes:', error);
    receivedContainer.innerText = 'Erreur lors du chargement.';
    return;
  }

  if (!pendingRequests?.length) {
    receivedContainer.innerText = 'Aucune demande pour le moment.';
    return;
  }

  for (const req of pendingRequests) {
    const uname = escapeHTML(req.requester?.username ?? 'Utilisateur');

    const card = document.createElement('div');
    card.className = 'friend-card';

    const content = document.createElement('div');
    content.className = 'friend-card-content';
    content.innerHTML = `<div class="friend-name-line"><strong>${uname}</strong> vous a envoy√© une demande.</div>`;

    const actions = document.createElement('div');
    actions.className = 'friend-card-actions';

    const acceptBtn = document.createElement('button');
    acceptBtn.textContent = 'Accepter';
    acceptBtn.onclick = async () => {
      await supabase.from('friends').update({ status: 'accepted' }).eq('id', req.id);
      manageSession();
    };

    const rejectBtn = document.createElement('button');
    rejectBtn.textContent = 'Refuser';
    rejectBtn.onclick = async () => {
      await supabase.from('friends').update({ status: 'rejected' }).eq('id', req.id);
      manageSession();
    };

    actions.append(acceptBtn, rejectBtn);
    card.append(content, actions);
    receivedContainer.appendChild(card);
  }
}

/* ------------------ Amis accept√©s ------------------ */
async function loadAcceptedFriends(userId) {
  const friendContainer = document.getElementById('accepted-friends');
  friendContainer.innerHTML = '';

  const { data: acceptedFriends, error } = await supabase
    .from('friends')
    .select(`
      id,
      status,
      requester:requester (
        id,
        username,
        is_online,
        currently_watching,
        episode_number,
        current_season,
        current_time
      ),
      requested:requested (
        id,
        username,
        is_online,
        currently_watching,
        episode_number,
        current_season,
        current_time
      )
    `)
    .or(`requester.eq.${userId},requested.eq.${userId}`)
    .eq('status', 'accepted');

  if (error) {
    console.error('Erreur fetch amis:', error);
    friendContainer.innerText = 'Erreur lors du chargement.';
    return;
  }

  if (!acceptedFriends?.length) {
    friendContainer.innerText = "Vous n'avez pas encore d'amis.";
    return;
  }

  for (const rel of acceptedFriends) {
    const friend = (rel.requester?.id === userId) ? rel.requested : rel.requester;
    if (!friend) continue;

    const uname = escapeHTML(friend.username ?? 'Utilisateur');
    const isOnline = !!friend.is_online;

    const statusSpan = document.createElement('span');
    statusSpan.className = isOnline ? 'online' : 'offline';
    statusSpan.textContent = isOnline ? 'üü¢ En ligne' : 'üî¥ Hors ligne';

    const card = document.createElement('div');
    card.className = 'friend-card';

    const content = document.createElement('div');
    content.className = 'friend-card-content';

    const nameLine = document.createElement('div');
    nameLine.className = 'friend-name-line';
    nameLine.innerHTML = `<strong>${uname}</strong> `;
    nameLine.appendChild(statusSpan);
    content.appendChild(nameLine);

    // Activit√©
    let watchingEl = null;
    const showId   = friend.currently_watching;
    const season   = friend.current_season;
    const episode  = friend.episode_number;
    const position = friend.current_time ?? 0;

    if (showId) {
      watchingEl = document.createElement('div');
      watchingEl.className = 'watching-activity';

      // L√©gende saison/√©pisode
      const parts = [];
      if (season != null) parts.push(`S${season}`);
      if (episode != null) parts.push(`√âpisode ${episode}`);
      const caption = parts.join(' ‚Äì ');

      // R√©cup image episode
      let imgUrl = PLACEHOLDER_IMG;
      if (season != null && episode != null) {
        const { data: epData, error: epError } = await supabase
          .from('episodes')
          .select('image_url')
          .eq('show_id', showId)
          .eq('season_number', season)
          .eq('episode_number', episode)
          .single();
        if (!epError && epData?.image_url) imgUrl = epData.image_url;
      }

      // ligne texte
      const safeTitle = escapeHTML(String(showId)); // si showId == titre, change selon ton sch√©ma
      const line = document.createElement('div');
      line.innerHTML = `üé¨ Regarde : <strong>${safeTitle}</strong>${caption ? ' ‚Äì ' + caption : ''}`;
      watchingEl.appendChild(line);

      // image
      const img = document.createElement('img');
      img.className = 'watching-thumb';
      img.src = imgUrl;
      img.alt = 'Vignette √©pisode';
      img.loading = 'lazy';
      watchingEl.appendChild(img);
    }

    if (watchingEl) content.appendChild(watchingEl);

    const actions = document.createElement('div');
    actions.className = 'friend-card-actions';

    // Chat
    const chatBtn = document.createElement('button');
    chatBtn.className = 'chat-btn';
    chatBtn.textContent = 'üí¨ Chat';
    chatBtn.onclick = () => {
      window.location.href = `chat.html?user=${friend.id}`;
    };
    actions.appendChild(chatBtn);

    // Invite Watch Party si ami regarde qqch
    if (showId) {
      const inviteBtn = document.createElement('button');
      inviteBtn.className = 'invite-btn';
      inviteBtn.textContent = '‚ñ∂ Regarder ensemble';
      inviteBtn.onclick = async () => {
        const sessionId = uuidv4(); // G√©n√®re une session
        // (optionnel) push dans DB invitation -> table invites
        /*
        await supabase.from('watch_party_invites').insert({
          session_id: sessionId,
          from_user: userId,
          to_user: friend.id,
          show_id: showId,
          season_number: season,
          episode_number: episode,
          start_time: position
        });
        */
        // Redirige l'h√¥te vers lecteur sync
        const url = `lecteur.html?session=${encodeURIComponent(sessionId)}&show=${encodeURIComponent(showId)}&season=${season ?? ''}&episode=${episode ?? ''}&t=${position}&role=host`;
        window.location.href = url;
      };
      actions.appendChild(inviteBtn);
    }

    // Remove
    const removeBtn = document.createElement('button');
    removeBtn.textContent = '‚ùå Supprimer';
    removeBtn.onclick = async () => {
      await supabase.from('friends').delete().eq('id', rel.id);
      manageSession();
    };
    actions.appendChild(removeBtn);

    card.append(content, actions);
    friendContainer.appendChild(card);
  }
}

/* ------------------ Realtime ------------------ */
/* recharge la page amis lorsque table friends ou profiles change */
supabase.channel('friends-realtime')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'friends' }, () => manageSession())
  .subscribe();

supabase.channel('profiles-realtime')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, () => manageSession())
  .subscribe();

/* ------------------ Init ------------------ */
manageSession();
</script>
</body>
</html>
