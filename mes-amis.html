<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mes amis</title>
  <style>
    :root {
      --accent: #e50914;
      --bg-1: #121212;
      --bg-2: #1e1e1e;
      --bg-header: #141414;
      --online: #00ff88;
      --offline: #888;
    }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg-1);
      color: #ffffff;
      padding: 20px;
      margin: 0;
    }
    header {
      background-color: var(--bg-header);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo { font-weight: bold; font-size: 20px; color: var(--accent); }
    .nav-links { list-style: none; padding: 0; display: flex; gap: 20px; margin: 0; }
    .nav-links a { color: #ffffff; text-decoration: none; font-weight: bold; font-size: 16px; }
    h1 { margin-top: 30px; }
    h2 { border-bottom: 1px solid #444; padding-bottom: 5px; margin-top: 40px; margin-bottom: 10px; font-size: 20px; }
    .friend-card {
      background: var(--bg-2);
      padding: 16px 20px;
      margin: 12px 0;
      border-radius: 10px;
      display: grid;
      grid-template-columns: auto 100px;
      gap: 16px;
      align-items: center;
    }
    .friend-card-content { display: flex; flex-direction: column; gap: 6px; }
    .friend-name-line { font-size: 18px; }
    .online  { color: var(--online);  font-size: 14px; margin-left: 4px; }
    .offline { color: var(--offline); font-size: 14px; margin-left: 4px; }
    .watching-activity { font-size: 15px; line-height: 1.3; display: flex; flex-direction: column; gap: 6px; }
    .watching-thumb { width: 100px; aspect-ratio: 16/9; object-fit: cover; border-radius: 6px; border: 1px solid #333; }
    .friend-card-actions { display: flex; flex-direction: column; gap: 8px; align-items: stretch; }
    button { background: var(--accent); color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-size: 14px; line-height: 1.2; }
    button.chat-btn { background: #0066ff; }
    a.back-link { color: var(--accent); text-decoration: none; font-weight: bold; display: inline-block; margin-top: 10px; }
    @media (max-width: 768px) {
      header { flex-direction: column; align-items: flex-start; }
      .nav-links { flex-direction: column; gap: 10px; width: 100%; }
      .friend-card { grid-template-columns: 1fr; }
      .friend-card-actions { flex-direction: row; justify-content: flex-start; }
      .watching-thumb { width: 100%; max-width: 300px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">BNZ</div>
    <nav>
      <ul class="nav-links">
        <li><a href="accueil.html">Accueil</a></li>
        <li><a href="journal.html">Journal</a></li>
        <li><a href="lecteurtest.html">Profil</a></li>
        <li><a href="profil.html">D√©couvrir</a></li>
        <li><a href="index.html">Home</a></li>
        <li><a href="amis.html">Amis</a></li>
        <li><a href="mes-amis.html">Mes amis</a></li>
        <li><a href="compte.html">Votre Compte</a></li>
      </ul>
    </nav>
  </header>

  <div style="margin-top: 10px;">
    <a class="back-link" href="index.html">‚Üê Retour</a>
  </div>

  <h1>üë• Mes amis</h1>

  <div class="section">
    <h2>Demandes re√ßues</h2>
    <div id="received-requests">Chargement...</div>
  </div>

  <div class="section">
    <h2>Amis accept√©s</h2>
    <div id="accepted-friends">Chargement...</div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.8.0/+esm';

    /* ---------- CONFIG SUPABASE ---------- */
    const supabase = createClient(
      'https://wuagahavmbugmnuzsouf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1YWdhaGF2bWJ1Z21udXpzb3VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MDM2NTksImV4cCI6MjA2ODE3OTY1OX0.mjf9cUleV_oq8TsWeKvPVOJSGPc98AyGyfJeA-Tpvho'
    );

    /* ---------- CONSTANTES ---------- */
    const PLACEHOLDER_IMG =
      'data:image/svg+xml;base64,' +
      btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 90" width="160" height="90" fill="none"><rect width="160" height="90" rx="8" fill="#333"/><text x="50%" y="50%" fill="#aaa" font-size="12" font-family="Arial" dominant-baseline="middle" text-anchor="middle">Aucune image</text></svg>');
    const ONLINE_THRESHOLD_MS   = 60_000;      // 60s
    const ACTIVITY_STALE_MS     = 5 * 60_000;  // 5 min
    const HEARTBEAT_INTERVAL_MS = 30_000;      // 30s
    const REFRESH_INTERVAL_MS   = 10_000;      // 10s

    /* ---------- HELPERS ---------- */
    function escapeHTML(str = '') {
      return str.replace(/[&<>"']/g, ch => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[ch]));
    }
    function sanitizeImg(url) {
      if (!url) return null;
      const u = String(url).trim();
      if (!u || u === '-' || u.toUpperCase() === 'NULL') return null;
      return u;
    }
    function msSince(ts) {
      if (!ts) return Infinity;
      return Date.now() - new Date(ts).getTime();
    }
    function isOnline(last_seen, fallbackBool) {
      const delta = msSince(last_seen);
      if (delta < ONLINE_THRESHOLD_MS) return true;
      if (fallbackBool != null) return !!fallbackBool;
      return false;
    }
    function isActivityFresh(last_seen) {
      return msSince(last_seen) < ACTIVITY_STALE_MS;
    }

    /* ---------- STATE ---------- */
    let currentUserId  = null;
    let heartbeatTimer = null;
    let refreshTimer   = null;

    /* ---------- PRESENCE HEARTBEAT ---------- */
    async function heartbeat() {
      if (!currentUserId) return;
      const { error } = await supabase
        .from('profiles')
        .update({
          last_seen: new Date().toISOString(),
          is_online: true
        })
        .eq('id', currentUserId);
      if (error) console.error('[heartbeat] update error:', error);
    }

    function startHeartbeat() {
      heartbeat();
      if (heartbeatTimer) clearInterval(heartbeatTimer);
      heartbeatTimer = setInterval(heartbeat, HEARTBEAT_INTERVAL_MS);
    }

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) heartbeat();
    });

    // Best effort : marquer hors ligne quand on quitte CETTE page
    window.addEventListener('beforeunload', async () => {
      if (!currentUserId) return;
      try {
        await supabase
          .from('profiles')
          .update({
            last_seen: new Date().toISOString(),
            is_online: false
          })
          .eq('id', currentUserId);
      } catch (_) {
        /* ignorer */
      }
    });

    /* ---------- SESSION ---------- */
    async function manageSession() {
      const { data: sessionData, error: sessErr } = await supabase.auth.getSession();
      if (sessErr) console.error('Erreur session:', sessErr);
      const session = sessionData?.session;
      if (!session) {
        document.body.innerHTML = 'üîí Vous devez √™tre connect√©.';
        return;
      }
      currentUserId = session.user.id;
      startHeartbeat();
      await Promise.all([
        loadPendingRequests(currentUserId),
        loadAcceptedFriends(currentUserId)
      ]);
    }

    /* ---------- DEMANDES RE√áUES ---------- */
    async function loadPendingRequests(userId) {
      const receivedContainer = document.getElementById('received-requests');
      receivedContainer.innerHTML = '';

      const { data, error } = await supabase
        .from('friends')
        .select('id, status, requester:requester(id, username)')
        .eq('requested', userId)
        .eq('status', 'pending');

      if (error) {
        console.error('[pending] fetch error:', error);
        receivedContainer.textContent = 'Erreur lors du chargement.';
        return;
      }
      if (!data?.length) {
        receivedContainer.textContent = 'Aucune demande pour le moment.';
        return;
      }

      data.forEach(req => {
        const uname = escapeHTML(req.requester?.username ?? 'Utilisateur');

        const card = document.createElement('div');
        card.className = 'friend-card';

        const content = document.createElement('div');
        content.className = 'friend-card-content';
        content.innerHTML =
          `<div class="friend-name-line"><strong>${uname}</strong> vous a envoy√© une demande.</div>`;

        const actions = document.createElement('div');
        actions.className = 'friend-card-actions';

        const acceptBtn = document.createElement('button');
        acceptBtn.textContent = 'Accepter';
        acceptBtn.onclick = async () => {
          await supabase.from('friends').update({ status: 'accepted' }).eq('id', req.id);
          manageSession();
        };

        const rejectBtn = document.createElement('button');
        rejectBtn.textContent = 'Refuser';
        rejectBtn.onclick = async () => {
          await supabase.from('friends').update({ status: 'rejected' }).eq('id', req.id);
          manageSession();
        };

        actions.append(acceptBtn, rejectBtn);
        card.append(content, actions);
        receivedContainer.appendChild(card);
      });
    }

    /* ---------- AMIS ACCEPT√âS ---------- */
    async function loadAcceptedFriends(userId) {
      const friendContainer = document.getElementById('accepted-friends');
      friendContainer.innerHTML = '';

      const orClause = `requester.eq.${userId},requested.eq.${userId}`;

      const { data, error } = await supabase
        .from('friends')
        .select(`
          id,
          status,
          requester:requester(
            id,
            username,
            is_online,
            last_seen,
            currently_watching,
            current_season,
            episode_number,
            episode_image
          ),
          requested:requested(
            id,
            username,
            is_online,
            last_seen,
            currently_watching,
            current_season,
            episode_number,
            episode_image
          )
        `)
        .or(orClause)
        .eq('status', 'accepted');

      if (error) {
        console.error('[amis] fetch error:', error);
        friendContainer.textContent = 'Erreur lors du chargement.';
        return;
      }
      if (!data?.length) {
        friendContainer.textContent = "Vous n'avez pas encore d'amis.";
        return;
      }

      data.forEach(rel => {
        const friend = (rel.requester?.id === userId) ? rel.requested : rel.requester;
        if (!friend) return;

        const uname = escapeHTML(friend.username ?? 'Utilisateur');

        // statut
        const online = isOnline(friend.last_seen, friend.is_online);
        const statusHTML = online
          ? '<span class="online">üü¢ En ligne</span>'
          : '<span class="offline">üî¥ Hors ligne</span>';

        // activit√© ‚Üí seulement si fresh
        let watchingHTML = '';
        if (isActivityFresh(friend.last_seen) && friend.currently_watching) {
          const safeTitle = escapeHTML(friend.currently_watching);
          const seasonPart = friend.current_season ? `S${friend.current_season}` : '';
          const epPart     = (friend.episode_number != null) ? `√âpisode ${friend.episode_number}` : '';
          const caption    = [seasonPart, epPart].filter(Boolean).join(' ‚Äì ');
          const imgUrl     = sanitizeImg(friend.episode_image) || PLACEHOLDER_IMG;
          watchingHTML = `
            <div class="watching-activity">
              <div>üé¨ Regarde : <strong>${safeTitle}</strong>${caption ? ' ‚Äì ' + caption : ''}</div>
              <img class="watching-thumb" src="${imgUrl}" alt="Vignette √©pisode en cours" loading="lazy" />
            </div>`;
        }

        // carte
        const card = document.createElement('div');
        card.className = 'friend-card';
        card.innerHTML = `
          <div class="friend-card-content">
            <div class="friend-name-line"><strong>${uname}</strong> ${statusHTML}</div>
            ${watchingHTML}
          </div>
          <div class="friend-card-actions">
            <button class="chat chat-btn">üí¨ Chat</button>
            <button class="remove">‚ùå Supprimer</button>
          </div>
        `;

        card.querySelector('.remove').onclick = async () => {
          await supabase.from('friends').delete().eq('id', rel.id);
          manageSession();
        };

        card.querySelector('.chat').onclick = () => {
          window.location.href = 'chat.html?user=' + friend.id;
        };

        friendContainer.appendChild(card);
      });
    }

    /* ---------- INIT ---------- */
    (async function init() {
      console.log('[mes-amis] init‚Ä¶');
      await manageSession();
      if (refreshTimer) clearInterval(refreshTimer);
      refreshTimer = setInterval(manageSession, REFRESH_INTERVAL_MS);
    })();
  </script>
</body>
</html>
