<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Messagerie</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }

    header {
      background-color: #141414;
      color: white;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    main {
      padding: 20px;
    }

    .message {
      background-color: #ffffff;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    form {
      display: flex;
      gap: 10px;
      padding: 20px;
      background: white;
      position: fixed;
      bottom: 0;
      width: 100%;
      box-shadow: 0 -1px 5px rgba(0, 0, 0, 0.1);
    }

    input[type="text"] {
      flex: 1;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    button {
      padding: 10px 20px;
      background-color: #e50914;
      border: none;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #c40811;
    }
  </style>
</head>
<body>

<header>
  <h2>Messagerie</h2>
  <!-- L'avatar et le nom du destinataire seront injectés ici dynamiquement -->
</header>

<main id="messages-container">
  <!-- Messages apparaîtront ici -->
</main>

<form id="message-form">
  <input type="text" id="message-input" placeholder="Tapez votre message..." required />
  <button type="submit">Envoyer</button>
</form>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://wuagahavmbugmnuzsouf.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1YWdhaGF2bWJ1Z21udXpzb3VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MDM2NTksImV4cCI6MjA2ODE3OTY1OX0.mjf9cUleV_oq8TsWeKvPVOJSGPc98AyGyfJeA-Tpvho'
  );

  let currentUserId = null;
  let currentUsername = "";
  let currentAvatar = "";
  let receiverId = ""; // À adapter dynamiquement si besoin
  let receiverUsername = "";
  let receiverAvatar = "";

  const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
  if (sessionError || !sessionData.session) {
    alert("Vous devez être connecté.");
    throw new Error("Utilisateur non connecté.");
  }
  currentUserId = sessionData.session.user.id;

  async function loadCurrentUserInfo() {
    const { data: userData, error } = await supabase
      .from("profiles")
      .select("username, avatar_url")
      .eq("id", currentUserId)
      .single();

    if (error) {
      console.error("Erreur récupération utilisateur :", error.message);
      return;
    }

    currentUsername = userData.username;
    currentAvatar = userData.avatar_url;
  }

  async function loadReceiverInfo() {
    // Simulé — en pratique, `receiverId` devrait être passé via URL ou context
    receiverId = prompt("ID du destinataire :");

    const { data: receiverData, error } = await supabase
      .from("profiles")
      .select("username, avatar_url")
      .eq("id", receiverId)
      .single();

    if (error) {
      console.error("Erreur destinataire :", error.message);
      return;
    }

    receiverUsername = receiverData.username;
    receiverAvatar = receiverData.avatar_url;

    const header = document.querySelector("header");
    const receiverSection = document.createElement("div");
    receiverSection.style.display = "flex";
    receiverSection.style.alignItems = "center";
    receiverSection.innerHTML = `
      <img src="${receiverAvatar}" alt="avatar" />
      <span style="margin-left: 10px;">${receiverUsername}</span>
    `;
    header.appendChild(receiverSection);
  }

  async function loadMessages() {
    const { data, error } = await supabase
      .from("messages")
      .select("*")
      .or(`sender.eq.${currentUserId},receiver.eq.${currentUserId}`)
      .order("created_at", { ascending: true });

    if (error) {
      console.error("Erreur chargement messages :", error.message);
      return;
    }

    const filtered = data.filter(
      (msg) =>
        (msg.sender === currentUserId && msg.receiver === receiverId) ||
        (msg.sender === receiverId && msg.receiver === currentUserId)
    );

    const container = document.getElementById("messages-container");
    container.innerHTML = "";

    filtered.forEach((msg) => {
      const div = document.createElement("div");
      div.className = "message";

      const isSender = msg.sender === currentUserId;
      const senderLabel = isSender ? "Moi" : receiverUsername;
      const avatarUrl = isSender ? currentAvatar : receiverAvatar;
      const date = new Date(msg.created_at).toLocaleString();

      div.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
          <img src="${avatarUrl}" alt="avatar" style="width: 30px; height: 30px; border-radius: 50%;">
          <strong>${senderLabel}</strong> <small>${date}</small>
        </div>
        <div>${msg.content}</div>
      `;
      container.appendChild(div);
    });

    container.scrollTop = container.scrollHeight;
  }

  document.getElementById("message-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const input = document.getElementById("message-input");
    const content = input.value.trim();
    if (!content) return;

    const { error } = await supabase.from("messages").insert([
      {
        sender: currentUserId,
        receiver: receiverId,
        content,
      },
    ]);

    if (error) {
      console.error("Erreur envoi message :", error.message);
      return;
    }

    input.value = "";
    await loadMessages();
  });

  await loadCurrentUserInfo();
  await loadReceiverInfo();
  await loadMessages();
</script>

</body>
</html>
