<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Suggestions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
/* ============================= */
/*        DESIGN TOKENS          */
/* ============================= */

:root {
  --bg-main: #0f0f14;
  --bg-panel: #17171d;
  --bg-card: #1f1f27;
  --bg-input: #2a2a34;

  --border-soft: rgba(255,255,255,.08);

  --text-main: #f5f5f7;
  --text-muted: #9ca3af;

  --primary: #3b82f6;
  --primary-hover: #2563eb;
  --danger: #dc2626;

  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 14px;

  --shadow-sm: 0 6px 16px rgba(0,0,0,.35);
  --shadow-md: 0 20px 40px rgba(0,0,0,.45);

  --transition: all .25s ease;
}

/* ============================= */
/*          RESET & BASE         */
/* ============================= */

* {
  box-sizing: border-box;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body {
  margin: 0;
  font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: radial-gradient(circle at top, #1a1a22, var(--bg-main));
  color: var(--text-main);
}

a, a:visited {
  color: var(--text-main);
  text-decoration: none;
}

h1 {
  text-align: center;
  margin: 32px 0;
  font-weight: 700;
  letter-spacing: .4px;
}

/* ============================= */
/*            HEADER             */
/* ============================= */

header {
  background: rgba(20,20,28,.85);
  backdrop-filter: blur(10px);
  padding: 14px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow-sm);
}

/* ============================= */
/*            LAYOUT             */
/* ============================= */

.container {
  max-width: 1000px;
  margin: 0 auto 90px;
  padding: 0 16px;
}

.board-header {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
}

/* ============================= */
/*             FORM              */
/* ============================= */

.suggestion-form {
  background: linear-gradient(180deg, #23232c, #1a1a22);
  padding: 18px;
  border-radius: var(--radius-lg);
  margin-bottom: 32px;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border-soft);
}

.suggestion-form textarea {
  width: 100%;
  min-height: 85px;
  resize: vertical;
  padding: 12px;
  border-radius: var(--radius-md);
  border: 1px solid var(--border-soft);
  background: var(--bg-input);
  color: var(--text-main);
  font-size: 14px;
  transition: var(--transition);
}

.row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 14px;
}

.suggestion-form select,
.suggestion-form button {
  padding: 10px 16px;
  border-radius: var(--radius-sm);
  font-weight: 600;
  cursor: pointer;
}

.suggestion-form select {
  background: var(--bg-input);
  color: var(--text-main);
  border: 1px solid var(--border-soft);
}

.suggestion-form button {
  background: linear-gradient(135deg, var(--primary), #60a5fa);
  color: #fff;
  border: none;
  transition: var(--transition);
}

.suggestion-form button:hover {
  transform: translateY(-1px);
  background: linear-gradient(135deg, var(--primary-hover), var(--primary));
}

/* ============================= */
/*           SUGGESTIONS         */
/* ============================= */

.suggestions-list {
  display: grid;
  gap: 20px;
}

.suggestion {
  position: relative;
  padding: 16px;
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-soft);
  background:
    linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.18)),
    var(--bg-card);
  box-shadow:
    0 1px 0 rgba(255,255,255,.04) inset,
    0 20px 40px rgba(0,0,0,.45);
  transition: var(--transition);
}

.suggestion:hover {
  transform: translateY(-3px) scale(1.005);
  box-shadow:
    0 1px 0 rgba(255,255,255,.06) inset,
    0 30px 60px rgba(0,0,0,.6);
}

.suggestion::after {
  content: "";
  position: absolute;
  inset: auto 0 0 0;
  height: 1px;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255,255,255,.08),
    transparent
  );
}

/* ============================= */
/*           HEADER CARD         */
/* ============================= */

.suggestion-header {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.meta {
  font-size: 12px;
  color: var(--text-muted);
}

/* ============================= */
/*            STATUS             */
/* ============================= */

.status-badge {
  padding: 5px 12px;
  font-size: 11px;
  border-radius: 999px;
  font-weight: 700;
  letter-spacing: .6px;
  text-transform: uppercase;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  box-shadow:
    0 0 0 1px rgba(255,255,255,.15) inset,
    0 4px 12px rgba(0,0,0,.4);
}

.status-Attente   { background: #7c3aed; color: #f5ebff; }
.status-Planifié  { background: #1e40af; color: #dbeafe; }
.status-En-cours  { background: #6d28d9; color: #ede9fe; }
.status-Terminé   { background: #15803d; color: #dcfce7; }
.status-Refusé    { background: #991b1b; color: #fee2e2; }

/* ============================= */
/*            CONTENT            */
/* ============================= */

.content {
  white-space: pre-wrap;
  line-height: 1.65;
  letter-spacing: .15px;
  font-size: 15px;
  margin: 0 0 12px;
}

/* ============================= */
/*            ACTIONS            */
/* ============================= */

.actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 6px;
}

.actions button,
.inline-form button {
  background: #2d2d38;
  color: #e5e7eb;
  border: 1px solid var(--border-soft);
  padding: 7px 12px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 12px;
  transition: var(--transition);
  position: relative;
}

.actions button:hover,
.inline-form button:hover {
  background: #3a3a48;
}

button:active {
  transform: translateY(1px);
}

/* ============================= */
/*           COMMENTS            */
/* ============================= */

.comment-section {
  margin-top: 14px;
  border-top: 1px dashed var(--border-soft);
  padding-top: 14px;
}

.comment {
  background:
    linear-gradient(180deg, rgba(255,255,255,.04), transparent),
    #2a2a35;
  border: 1px solid rgba(255,255,255,.06);
  padding: 8px 10px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  margin-bottom: 6px;
}

.comment strong {
  color: #fff;
}

.comment time {
  color: var(--text-muted);
  font-size: 11px;
  margin-left: 6px;
}

/* ============================= */
/*          INLINE FORM          */
/* ============================= */

.inline-form {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

.inline-form input {
  flex: 1;
  padding: 9px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-soft);
  background: var(--bg-input);
  color: var(--text-main);
  font-size: 13px;
  transition: var(--transition);
}

/* ============================= */
/*            FILTER             */
/* ============================= */

.filter-bar {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin: 20px 0;
}

.filter-bar select {
  background: var(--bg-input);
  color: var(--text-main);
  border: 1px solid var(--border-soft);
  padding: 9px 12px;
  border-radius: var(--radius-sm);
}

/* ============================= */
/*         BADGES & STATES       */
/* ============================= */

.admin-badge {
  position: relative;
  background: linear-gradient(135deg, #e50914, #b20710);
  padding: 4px 10px;
  font-size: 11px;
  border-radius: 999px;
  font-weight: 800;
  margin-left: 8px;
  box-shadow: var(--shadow-sm);
}

.admin-badge::after {
  content: "";
  position: absolute;
  inset: -2px;
  border-radius: inherit;
  background: linear-gradient(135deg, #ff4d4d, transparent);
  opacity: .35;
  z-index: -1;
}

.danger {
  background: var(--danger) !important;
  color: #fff;
}

.danger:hover {
  background: #b91c1c !important;
}

/* ============================= */
/*          FOCUS STATES         */
/* ============================= */

textarea:focus-visible,
input:focus-visible,
select:focus-visible,
button:focus-visible {
  outline: none;
  border-color: var(--primary);
  box-shadow:
    0 0 0 2px rgba(59,130,246,.25),
    0 0 30px rgba(59,130,246,.15);
}

/* ============================= */
/*           EMPTY / LOAD        */
/* ============================= */

.no-data {
  text-align: center;
  color: var(--text-muted);
  padding: 40px 0;
}

.loading {
  text-align: center;
  padding: 40px;
  color: var(--text-muted);
}

.loading::after {
  content: "…";
  animation: dots 1.4s infinite;
}

@keyframes dots {
  0%   { content: ""; }
  33%  { content: "."; }
  66%  { content: ".."; }
  100% { content: "..."; }
}

  </style>
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    /* ========= Config Supabase ========= */
    const supabase = createClient(
      'https://wuagahavmbugmnuzsouf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1YWdhaGF2bWJ1Z21udXpzb3VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MDM2NTksImV4cCI6MjA2ODE3OTY1OX0.mjf9cUleV_oq8TsWeKvPVOJSGPc98AyGyfJeA-Tpvho'
    );

    /* ========= DOM ========= */
    const suggestionsList = document.getElementById('suggestionsList');
    const suggestionForm  = document.getElementById('suggestionForm');
    const suggestionText  = document.getElementById('suggestionText');
    const initialStatus   = document.getElementById('initialStatus');
    const filterStatus    = document.getElementById('filterStatus');
    const totalCount      = document.getElementById('totalCount');
    const emptyMessage    = document.getElementById('emptyMessage');
    const currentUserInfo = document.getElementById('currentUserInfo');

    /* ========= État ========= */
    let suggestions = [];  // {id,text,status,created_at,author_pseudo,author_email,comments:[]}
    let currentUser = null;
    let isAdmin = false;
    let loading = false;

    /* ========= Utils ========= */
    function escapeHtml(str='') {
      return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }
    function formatDate(d) {
      return new Date(d).toLocaleString('fr-FR',{dateStyle:'short', timeStyle:'short'});
    }
    const STATUSES = ['En Attente','Planifié','En cours','Terminé','Refusé'];

    function statusButtonsHTML(current) {
      return STATUSES.map(st => `
        <button data-action="status-${st}" ${st===current?'style="outline:2px solid #fff;"':''}>${st}</button>
      `).join('');
    }

    function setLoading(state) {
      loading = state;
      if (state) {
        suggestionsList.innerHTML = '<div class="loading">Chargement...</div>';
      }
    }

    /* ========= Auth / User local ========= */
    function detectLocalUser() {
      try {
        const cu = JSON.parse(localStorage.getItem('currentUser') || 'null');
        if (cu) {
          currentUser = cu;
          isAdmin = !!cu.isAdmin || cu.email === 'lolovp.portrets41@gmail.com';
          currentUserInfo.innerHTML = `Connecté : <strong>${escapeHtml(cu.pseudo || '')}</strong>${isAdmin?'<span class="admin-badge">ADMIN</span>':''}`;
        } else {
          currentUserInfo.innerHTML = '<em>Non connecté (local)</em>';
        }
      } catch(e) {
        currentUserInfo.innerHTML = '<em>Non connecté</em>';
      }
    }

    async function detectSupabaseUser() {
      const { data } = await supabase.auth.getUser();
      if (data?.user && !currentUser) {
        currentUser = {
          pseudo: data.user.user_metadata?.username || data.user.email?.split('@')[0],
          email: data.user.email
        };
        isAdmin = currentUser.email === 'lolovp.portrets41@gmail.com';
        currentUserInfo.innerHTML = `Connecté : <strong>${escapeHtml(currentUser.pseudo)}</strong>${isAdmin?'<span class="admin-badge">ADMIN</span>':''}`;
      }

      if (!isAdmin && initialStatusWrapper) {
        initialStatusWrapper.remove();
      }
    }

    /* ========= Chargement / Persistance Supabase ========= */
    async function loadSuggestionsFromSupabase() {
      setLoading(true);
      const { data, error } = await supabase
        .from('suggestions')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        suggestionsList.innerHTML = '<div class="loading">Erreur de chargement</div>';
        console.error(error);
        setLoading(false);
        return;
      }

      const ids = data.map(s => s.id);
      let commentsMap = {};
      if (ids.length) {
        const { data: comms, error: cErr } = await supabase
          .from('comments')
          .select('*')
          .in('suggestion_id', ids)
          .order('created_at',{ascending:true});
        if (!cErr) {
          comms.forEach(c => {
            if (!commentsMap[c.suggestion_id]) commentsMap[c.suggestion_id] = [];
            commentsMap[c.suggestion_id].push(c);
          });
        }
      }

      suggestions = data.map(s => ({
        ...s,
        comments: commentsMap[s.id] || []
      }));

      setLoading(false);
      render();
    }

    /* ========= Ajout suggestion ========= */
    async function addSuggestion(text, status) {
      const {
        data: { user },
        error: userError
      } = await supabase.auth.getUser();

      let payload;

      if (user && !userError) {
        // Utilisateur connecté
        payload = {
          text,
          status,
          author_pseudo: currentUser?.pseudo || user.user_metadata?.username || user.email?.split('@')[0],
          author_email: currentUser?.email || user.email,
          user_id: user.id
        };
      } else {
        // Invité
        payload = {
          text,
          status,
          author_pseudo: "Invité",
          author_email: null,
          user_id: null
        };
      }

      const { data, error } = await supabase
        .from('suggestions')
        .insert(payload)
        .select()
        .single();

      if (error) {
        alert('Erreur ajout: ' + error.message);
        return;
      }

      data.comments = [];
      suggestions.unshift(data);
      render();
    }

    async function updateSuggestionStatus(id, newStatus) {
      const { error } = await supabase
        .from('suggestions')
        .update({ status: newStatus })
        .eq('id', id);
      if (error) {
        alert('Erreur statut: '+error.message);
        return;
      }
      const s = suggestions.find(s => s.id === id);
      if (s) s.status = newStatus;
      render();
    }

    async function deleteSuggestion(id) {
      const { error } = await supabase.from('suggestions').delete().eq('id', id);
      if (error) {
        alert('Erreur suppression: ' + error.message);
        return;
      }
      suggestions = suggestions.filter(s => s.id !== id);
      render();
    }

    /* ========= Ajout commentaire ========= */
    async function addComment(suggestionId, text) {
      const {
        data: { user },
        error: userError
      } = await supabase.auth.getUser();

      let payload;

      if (user && !userError) {
        payload = {
          suggestion_id: suggestionId,
          content: text,
          author_pseudo: currentUser?.pseudo || user.user_metadata?.username || user.email?.split('@')[0],
          author_email: currentUser?.email || user.email,
          user_id: user.id
        };
      } else {
        payload = {
          suggestion_id: suggestionId,
          content: text,
          author_pseudo: "Invité",
          author_email: null,
          user_id: null
        };
      }

      const { data, error } = await supabase
        .from('comments')
        .insert(payload)
        .select()
        .single();

      if (error) {
        alert('Erreur commentaire: ' + error.message);
        return;
      }

      const s = suggestions.find(s => s.id === suggestionId);
      if (s) {
        s.comments.push(data);
        render();
      }
    }

    /* ========= Rendu ========= */
    function render() {
      const fStatus = filterStatus.value;
      let list = fStatus ? suggestions.filter(s => s.status === fStatus) : suggestions;

      suggestionsList.innerHTML = '';
      totalCount.textContent = `${list.length} suggestion${list.length>1?'s':''}`;
      emptyMessage.style.display = list.length ? 'none' : 'block';

      list.forEach(s => {
        const div = document.createElement('div');
        div.className = 'suggestion';
        const badgeClass = 'status-' + s.status.replace(' ','\\ ');

        const canModerate = isAdmin;

        div.innerHTML = `
          <div class="suggestion-header">
            <div>
              <span class="status-badge ${badgeClass}">${escapeHtml(s.status)}</span>
            </div>
            <div class="meta">
              ${s.author_pseudo ? 'Par <strong>'+escapeHtml(s.author_pseudo)+'</strong>' : '<strong>Utilisateur</strong>'}
              ${s.created_at ? ' • <time>'+formatDate(s.created_at)+'</time>' : ''}
            </div>
          </div>
          <p class="content">${escapeHtml(s.text)}</p>

          <div class="actions" data-id="${s.id}">
            ${canModerate ? statusButtonsHTML(s.status) : ''}
            ${canModerate ? '<button data-action="delete" class="danger">Supprimer</button>' : ''}
          </div>

          <div class="comment-section">
            <strong>Commentaires (${s.comments.length})</strong>
            <div class="comments">
              ${s.comments.map(c => `
                <div class="comment">
                  <strong>${escapeHtml(c.author_pseudo || 'Anonyme')}</strong>
                  <time>${formatDate(c.created_at)}</time><br>
                  ${escapeHtml(c.content)}
                </div>`).join('')}
            </div>
            <form class="inline-form" data-id="${s.id}">
              <input type="text" placeholder="Ajouter un commentaire..." required />
              <button type="submit">Envoyer</button>
            </form>
          </div>
        `;
        suggestionsList.appendChild(div);
      });

      document.querySelectorAll('.inline-form').forEach(form => {
        form.addEventListener('submit', e => {
          e.preventDefault();
          const id = Number(form.getAttribute('data-id'));
          const input = form.querySelector('input');
          const val = input.value.trim();
          if (!val) return;
          addComment(id, val);
          input.value = '';
        });
      });

      document.querySelectorAll('.actions').forEach(block => {
        block.addEventListener('click', e => {
          const btn = e.target.closest('button');
          if (!btn) return;
          const id = Number(block.getAttribute('data-id'));
          const action = btn.getAttribute('data-action');
          if (action === 'delete' && isAdmin) {
            if (confirm('Supprimer cette suggestion ?')) deleteSuggestion(id);
          } else if (action?.startsWith('status-') && isAdmin) {
            const newStatus = action.replace('status-','');
            updateSuggestionStatus(id, newStatus);
          }
        });
      });
    }

    /* ========= Events ========= */
    suggestionForm.addEventListener('submit', e => {
      e.preventDefault();
      const text = suggestionText.value.trim();
      if (!text) return;
      addSuggestion(text, initialStatus.value);
      suggestionText.value = '';
    });

    filterStatus.addEventListener('change', render);

    /* ========= Initialisation ========= */
    detectLocalUser();
    await detectSupabaseUser();
    loadSuggestionsFromSupabase();
</script>

</head>
<body>
  <header>
    <div><a href="https://inspecteurl.github.io/site/index.html">← Retour</a></div>
    <div id="currentUserInfo"></div>
  </header>
   <h1>Suggestions</h1>
  
  <div class="container">
    <div class="board-header">
      <div class="filter-bar">
        <select id="filterStatus">
          <option value="">Filtrer par statut</option>
          <option value="Planifié">Planifié</option>
          <option value="En cours">En cours</option>
          <option value="Terminé">Terminé</option>
          <option value="Refusé">Refusé</option>
        </select>
      </div>
      <div id="totalCount">Suggestions : 0</div>
    </div>

    <div class="suggestion-form">
      <form id="suggestionForm">
        <textarea id="suggestionText" placeholder="Exprime ta suggestion..."></textarea>
        <div class="row">
          <!-- NOTE: wrapper pour pouvoir retirer facilement le select si non-admin -->
          <div id="initialStatusWrapper">
            <select id="initialStatus">
              <option value="En Attente">En Attente</option>
              <option value="Planifié">Planifié</option>
              <option value="En cours">En cours</option>
              <option value="Terminé">Terminé</option>
              <option value="Refusé">Refusé</option>
            </select>
          </div>
          <button type="submit">Ajouter</button>
        </div>
      </form>
    </div>

    <div id="emptyMessage" class="no-data">Aucune suggestion pour le moment.</div>
    <div id="suggestionsList" class="suggestions-list"></div>
  </div>
</body>
</html>
