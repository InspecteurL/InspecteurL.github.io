<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mes amis</title>
  <style>
   /* ============================= */
/*         DESIGN TOKENS         */
/* ============================= */
:root {
  --accent: #e50914;
  --bg-main: #121212;
  --bg-panel: #1e1e1e;
  --bg-header: #141414;
  --online: #00ff88;
  --offline: #888;
  --radius-sm: 6px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --shadow-sm: 0 6px 16px rgba(0,0,0,.35);
  --shadow-md: 0 15px 35px rgba(0,0,0,.55);
  --transition: all .3s ease;
}

/* ============================= */
/*            BASE               */
/* ============================= */
* {
  box-sizing: border-box;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body {
  font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-main);
  color: #fff;
  margin: 0;
  padding: 20px;
}

/* ============================= */
/*           HEADER              */
/* ============================= */
header {
  background: var(--bg-header);
  padding: 14px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  box-shadow: var(--shadow-sm);
}

.logo {
  font-weight: 800;
  font-size: 20px;
  color: var(--accent);
}

.nav-links {
  list-style: none;
  padding: 0;
  display: flex;
  gap: 22px;
  margin: 0;
}

.nav-links a {
  color: #fff;
  text-decoration: none;
  font-weight: 600;
  font-size: 14px;
  opacity: .85;
  position: relative;
  transition: var(--transition);
}

.nav-links a:hover {
  opacity: 1;
}

.nav-links a::after {
  content: "";
  position: absolute;
  left: 0;
  bottom: -4px;
  width: 0;
  height: 2px;
  background: var(--accent);
  transition: var(--transition);
}

.nav-links a:hover::after {
  width: 100%;
}

/* ============================= */
/*            TITLES             */
/* ============================= */
h1 {
  margin-top: 30px;
  text-align: center;
  font-size: 2rem;
  color: var(--accent);
}

h2 {
  border-bottom: 1px solid #444;
  padding-bottom: 5px;
  margin-top: 40px;
  margin-bottom: 10px;
  font-size: 20px;
  color: #fff;
}

/* ============================= */
/*           FRIEND CARD          */
/* ============================= */
.friend-card {
  background: var(--bg-panel);
  border-radius: var(--radius-md);
  padding: 16px 20px;
  margin: 14px 0;
  display: grid;
  grid-template-columns: auto 100px;
  gap: 16px;
  align-items: center;
  box-shadow: var(--shadow-sm);
  transition: var(--transition);
}

.friend-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
}

/* Banner */
.friend-card .banner {
  width: 100%;
  height: 120px;
  overflow: hidden;
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.friend-card .banner img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.friend-card:hover .banner img {
  transform: scale(1.05);
}

/* Avatar */
.friend-card .avatar {
  position: relative;
  margin-top: -40px;
  text-align: center;
}

.friend-card .avatar img {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 3px solid var(--bg-main);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.friend-card .avatar img:hover {
  transform: scale(1.1);
  box-shadow: 0 8px 20px rgba(229,9,20,.4);
}

/* Content */
.friend-card-content {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.friend-card .name {
  font-size: 18px;
  font-weight: 700;
  color: var(--accent);
  text-align: left;
}

.friend-card .status {
  font-size: 14px;
  margin-bottom: 10px;
}

.friend-card .status.online {
  color: var(--online);
}

.friend-card .status.offline {
  color: var(--offline);
}

.friend-card .watching-activity {
  font-size: 15px;
  line-height: 1.3;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.friend-card .watching-activity strong {
  font-weight: bold;
}

.watching-thumb {
  width: 80%;
  max-width: 320px;
  aspect-ratio: 16 / 9;
  object-fit: cover;
  border-radius: var(--radius-md);
  border: 1px solid #333;
  margin: 12px auto;
  display: block;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.watching-thumb:hover {
  transform: scale(1.03);
  box-shadow: 0 6px 20px rgba(0,0,0,.4);
}

/* Actions / Buttons */
.friend-card-actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: stretch;
}

button {
  background: var(--accent);
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 14px;
  transition: var(--transition);
}

button.chat-btn {
  background: #0066ff;
}

button:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(0,0,0,.4);
}

a.back-link {
  color: var(--accent);
  text-decoration: none;
  font-weight: bold;
  display: inline-block;
  margin-top: 10px;
  transition: var(--transition);
}

a.back-link:hover {
  text-decoration: underline;
}

/* ============================= */
/*          RESPONSIVE           */
/* ============================= */
@media (max-width: 768px) {
  header {
    flex-direction: column;
    align-items: flex-start;
  }

  .nav-links {
    flex-direction: column;
    gap: 10px;
    width: 100%;
  }

  .friend-card {
    grid-template-columns: 1fr;
    gap: 14px;
  }

  .friend-card-actions {
    flex-direction: row;
    justify-content: flex-start;
    gap: 8px;
  }

  .watching-thumb {
    width: 100%;
    max-width: 300px;
  }
}

  </style>
</head>
<body>
  <header>
    <div class="logo">BNZ</div>
    <nav>
      <ul class="nav-links">
        <li><a href="https://inspecteurl.github.io/site/lecteurtest.html">Donn√©es Animes</a></li>
        <li><a href="https://inspecteurl.github.io/site/index.html">Home</a></li>
        <li><a href="https://inspecteurl.github.io/site/amis.html">Rechercher des Utilisateurs</a></li>
        <li><a href="https://inspecteurl.github.io/site/mes-amis.html">Mes amis</a></li>
        <li><a href="https://inspecteurl.github.io/site/compte.html">Votre Compte</a></li>
      </ul>
    </nav>
  </header>

  <div style="margin-top: 10px;">
    <a class="back-link" href="index.html">‚Üê Retour</a>
  </div>

  <h1>üë• Mes amis</h1>

  <div class="section">
    <h2>Demandes re√ßues</h2>
    <div id="received-requests">Chargement...</div>
  </div>

  <div class="section">
    <h2>Amis accept√©s</h2>
    <div id="accepted-friends">Chargement...</div>
  </div>

  <script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.8.0/+esm';

const supabase = createClient(
  'https://wuagahavmbugmnuzsouf.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1YWdhaGF2bWJ1Z21udXpzb3VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MDM2NTksImV4cCI6MjA2ODE3OTY1OX0.mjf9cUleV_oq8TsWeKvPVOJSGPc98AyGyfJeA-Tpvho'
);

async function manageSession() {
  const { data: sessionData, error: sessErr } = await supabase.auth.getSession();
  if (sessErr) console.error('Erreur session:', sessErr);
  const session = sessionData?.session;
  if (!session) {
    document.body.innerHTML = "üîí Vous devez √™tre connect√©.";
    return;
  }
  const userId = session.user.id;

  await loadPendingRequests(userId);
  await loadAcceptedFriends(userId);
}

async function loadPendingRequests(userId) {
  const receivedContainer = document.getElementById("received-requests");
  receivedContainer.innerHTML = "";

  const { data: pendingRequests, error } = await supabase
    .from("friends")
    .select("id, status, requester:requester(id, username)")
    .eq("requested", userId)
    .eq("status", "pending");

  if (error) {
    console.error("Erreur fetch demandes:", error);
    receivedContainer.innerText = "Erreur lors du chargement.";
    return;
  }

  if (!pendingRequests || pendingRequests.length === 0) {
    receivedContainer.innerText = "Aucune demande pour le moment.";
    return;
  }

  for (const req of pendingRequests) {
    const uname = req.requester?.username ?? "Utilisateur";
    const div = document.createElement("div");
    div.className = "friend-card";
    div.innerHTML = `
      <div class="friend-card-content">
        <div class="friend-name-line"><strong>${uname}</strong> vous a envoy√© une demande.</div>
      </div>
      <div class="friend-card-actions">
        <button class="accept">Accepter</button>
        <button class="reject">Refuser</button>
      </div>
    `;

    div.querySelector(".accept").onclick = async () => {
      await supabase.from("friends").update({ status: "accepted" }).eq("id", req.id);
      manageSession();
    };

    div.querySelector(".reject").onclick = async () => {
      await supabase.from("friends").update({ status: "rejected" }).eq("id", req.id);
      manageSession();
    };

    receivedContainer.appendChild(div);
  }
}

async function loadAcceptedFriends(userId) {
  const friendContainer = document.getElementById("accepted-friends");
  friendContainer.innerHTML = "";

  const { data: acceptedFriends, error } = await supabase
    .from("friends")
    .select(`
      id, status,
      requester:requester(
        id, username, is_online, currently_watching, episode_number, episode_image, current_season, avatar_url, banner_url
      ),
      requested:requested(
        id, username, is_online, currently_watching, episode_number, episode_image, current_season, avatar_url, banner_url
      )
    `)
    .or(`requester.eq.${userId},requested.eq.${userId}`)
    .eq("status", "accepted");

  if (error) {
    console.error("Erreur fetch amis:", error);
    friendContainer.innerText = "Erreur lors du chargement.";
    return;
  }

  if (!acceptedFriends || acceptedFriends.length === 0) {
    friendContainer.innerText = "Vous n'avez pas encore d'amis.";
    return;
  }

  for (const rel of acceptedFriends) {
    const friend = (rel.requester.id === userId) ? rel.requested : rel.requester;
    const avatarURL = friend.avatar_url || "default_avatar.jpg";
    const bannerURL = friend.banner_url || "default_banner.jpg";

    const uname = friend.username ?? "Utilisateur";
    const isOnline = friend.is_online;
    const status = isOnline
      ? `<span class="online">üü¢ En ligne</span>`
      : `<span class="offline">üî¥ Hors ligne</span>`;

    const watchingTitle = friend.currently_watching;
    const epNum = friend.episode_number;
    const epImg = friend.episode_image;
    const seasonNum = friend.current_season;

    let watchingHTML = "";
    if (watchingTitle) {
      const seasonPart = seasonNum ? `S${seasonNum} - ` : "";
      const epPart = (epNum != null) ? `√âpisode ${epNum}` : "";
      const caption = `${seasonPart}${epPart}`.trim();

      const imgHTML = epImg
        ? `<img class="watching-thumb" src="${epImg}" alt="Vignette √©pisode en cours" loading="lazy" />`
        : "";

      watchingHTML = `
        <div class="watching-activity">
          <div>üé¨ Regarde : <strong>${watchingTitle}</strong>${caption ? " ‚Äì " + caption : ""}</div>
          ${imgHTML}
        </div>
      `;
    }

    const div = document.createElement("div");
    div.className = "friend-card";
div.innerHTML = `
  <div class="banner">
    <img src="${bannerURL}" alt="Banni√®re">
  </div>
  <div class="avatar">
    <img src="${avatarURL}" alt="Avatar">
  </div>
  <div class="name">${uname}</div>
  <div class="status ${isOnline ? 'online' : 'offline'}">${status.replace(/<\/?span[^>]*>/g, '')}</div>
  ${watchingHTML}
  <div class="friend-card-actions">
    <button class="chat chat-btn">üí¨ Chat</button>
    <button class="remove">‚ùå Supprimer</button>
  </div>
`;


    div.querySelector(".remove").onclick = async () => {
      await supabase.from("friends").delete().eq("id", rel.id);
      manageSession();
    };

    div.querySelector(".chat").onclick = () => {
      window.location.href = `chat.html?user=${friend.id}`;
    };

    friendContainer.appendChild(div);
  }
}

await manageSession();
setInterval(manageSession, 10000);


</script>
</body>
</html>


